ALTER PROCEDURE [dbo].[SP_FARMERS]
(
@MODE INT NULL,
@SLNO INT =NULL,
@FARMERID INT=NULL,
@FARMERNAME VARCHAR(250)=NULL,
@MOBILENO VARCHAR(20)=NULL,
@MILKTYPE VARCHAR(20)=NULL,
@ISACTIVE BIT=NULL
)
AS
IF @MODE = 1
BEGIN
INSERT INTO TBLFARMERS (FARMERID,FARMERNAME,MOBILENO,MILKTYPE,ISACTIVE)
VALUES( @FARMERID,@FARMERNAME,@MOBILENO,@MILKTYPE,@ISACTIVE)
END
ELSE IF @MODE=2
BEGIN
SELECT * FROM TBLFARMERS
END
ELSE IF @MODE=3
BEGIN
UPDATE TBLFARMERS SET FARMERID=@FARMERID,FARMERNAME=@FARMERNAME,MOBILENO=@MOBILENO,ISACTIVE=@ISACTIVE WHERE SLNO=@SLNO
END
ELSE IF @MODE=4
BEGIN
DELETE FROM TBLFARMERS WHERE SLNO=@SLNO
END
ELSE IF @MODE=5
BEGIN
SELECT FARMERID,FARMERNAME,MOBILENO,MILKTYPE,ISACTIVE FROM TBLFARMERS WHERE FARMERID=@FARMERID
END


____________________________________________________________________


ALTER PROCEDURE [dbo].[SP_GPSTEST]
(
@MODE INT NULL,
@SLNO INT =NULL,
@TDATE DATETIME = NULL,
@USERID VARCHAR(50) =NULL,
@LAT VARCHAR(20)=NULL,
@LONG VARCHAR(20)=NULL
)
AS

IF @MODE=1
BEGIN
SET @SLNO = (SELECT ISNULL(MAX(SLNO),0)+1 FROM TBLGPSTEST)
INSERT INTO TBLGPSTEST (SLNO,TDATE,USERID,LAT,LONG)
VALUES
(@SLNO,@TDATE,@USERID,@LAT,@LONG)
END

________________________________________________________________________

ALTER PROCEDURE [dbo].[SP_MILKDATA]
(
@MODE INT =NULL,
@SLNO INT =NULL,
@TDATE DATETIME=NULL,
@SHIFT VARCHAR(20)=NULL,
@FARMERID INT=NULL,
@FARMERNAME VARCHAR(250)=NULL,
@MILKTYPE VARCHAR(20)=NULL,
@QUANTITY DECIMAL(18,2)=NULL,
@FAT DECIMAL(18,2)=NULL,
@SNF DECIMAL(18,2)=NULL,
@RATE DECIMAL(18,2)=NULL,
@AMOUNT DECIMAL(18,2)=NULL
)
AS
IF @MODE=1
BEGIN
SET @SLNO = (SELECT ISNULL(MAX(SLNO),0)+1 FROM TBLMILKDATA)
INSERT INTO TBLMILKDATA (SLNO,TDATE,SHIFT,FARMERID,FARMERNAME,MILKTYPE,QUANTITY,FAT,SNF,RATE,AMOUNT,CRDATE)
VALUES
(@SLNO,@TDATE,@SHIFT,@FARMERID,@FARMERNAME,@MILKTYPE,@QUANTITY,@FAT,@SNF,@RATE,@AMOUNT,GETDATE())
END

ELSE IF @MODE=2
BEGIN
SELECT SLNO,TDATE,SHIFT,FARMERID,FARMERNAME,MILKTYPE,QUANTITY,FAT,SNF,RATE,AMOUNT,CRDATE FROM TBLMILKDATA
END

ELSE IF @MODE=3
BEGIN
UPDATE TBLMILKDATA SET TDATE=@TDATE,SHIFT=@SHIFT,FARMERID=@FARMERID,FARMERNAME=@FARMERNAME,MILKTYPE=@MILKTYPE,QUANTITY=@QUANTITY,FAT=@FAT,SNF=@SNF,RATE=@RATE,AMOUNT=@AMOUNT,CRDATE=GETDATE() WHERE SLNO=@SLNO
END

ELSE IF @MODE=4
BEGIN
DELETE FROM TBLMILKDATA WHERE SLNO=@SLNO
END

ELSE IF @MODE=5
BEGIN
SELECT SLNO,TDATE,SHIFT,FARMERID,FARMERNAME,MILKTYPE,QUANTITY,FAT,SNF,RATE,AMOUNT,CRDATE FROM TBLMILKDATA WHERE TDATE=@TDATE AND SHIFT=@SHIFT
END

_____________________________________________________________________________

ALTER PROCEDURE [dbo].[SP_RATES]
(
@MODE INT NULL,
@SLNO INT =NULL,
@MILKTYPE VARCHAR(20) =NULL,
@TDATE DATETIME = NULL,
@FAT DECIMAL(18,2)=NULL,
@SNF DECIMAL(18,2)=NULL,
@STARTDATE DATETIME =NULL,
@ENDDATE DATETIME = NULL,
@FATMIN DECIMAL(18,2)=NULL,
@FATMAX DECIMAL(18,2)=NULL,
@SNFMIN DECIMAL(18,2)=NULL,
@SNFMAX DECIMAL(18,2)=NULL,
@RATE DECIMAL(18,2)=NULL
)
AS
IF @MODE=1
BEGIN
--SET @SLNO = (SELECT ISNULL(MAX(SLNO),0)+1 FROM TBLRATES)
--INSERT INTO TBLRATES (SLNO,MILKTYPE,STARTDATE,ENDDATE,FATMIN,FATMAX,SNFMIN,SNFMAX,RATE)
--VALUES (@SLNO,@MILKTYPE,@STARTDATE,@ENDDATE,@FATMIN,@FATMAX,@SNFMIN,@SNFMAX,@RATE)
SELECT SLNO,MILKTYPE,STARTDATE,ENDDATE,FATMIN,FATMAX,SNFMIN,SNFMAX,RATE FROM TBLRATES WHERE MILKTYPE=@MILKTYPE AND @STARTDATE BETWEEN STARTDATE AND ENDDATE AND @ENDDATE BETWEEN STARTDATE AND ENDDATE
IF @@ROWCOUNT>0
RAISERROR('RATES FOUND FOR THE GIVEN DATES',18,0)
ELSE
SET @SLNO = (SELECT ISNULL(MAX(SLNO),0)+1 FROM TBLRATES)
INSERT INTO TBLRATES (SLNO,MILKTYPE,STARTDATE,ENDDATE,FATMIN,FATMAX,SNFMIN,SNFMAX,RATE)
VALUES (@SLNO,@MILKTYPE,@STARTDATE,@ENDDATE,@FATMIN,@FATMAX,@SNFMIN,@SNFMAX,@RATE)
END
ELSE IF @MODE=2
BEGIN
SELECT SLNO,MILKTYPE,STARTDATE,ENDDATE,FATMIN,FATMAX,SNFMIN,SNFMAX,RATE FROM TBLRATES
END
ELSE IF @MODE=3
BEGIN
UPDATE TBLRATES SET MILKTYPE=@MILKTYPE,STARTDATE=@STARTDATE,ENDDATE=@ENDDATE,FATMIN=@FATMIN,FATMAX=@FATMAX,SNFMIN=@SNFMIN,SNFMAX=@SNFMAX,RATE=@RATE WHERE SLNO=@SLNO
END
ELSE IF @MODE=4
BEGIN
DELETE FROM TBLRATES WHERE SLNO=@SLNO
END
ELSE IF @MODE=5
BEGIN
SELECT SLNO,MILKTYPE,STARTDATE,ENDDATE,FATMIN,FATMAX,SNFMIN,SNFMAX,RATE FROM TBLRATES WHERE SLNO=@SLNO
END
ELSE IF @MODE=6
BEGIN
SELECT TOP 1 SLNO,MILKTYPE,STARTDATE,ENDDATE,FATMIN,FATMAX,SNFMIN,SNFMAX,RATE FROM TBLRATES WHERE MILKTYPE=@MILKTYPE and @TDATE BETWEEN STARTDATE AND ENDDATE AND @FAT BETWEEN FATMIN AND FATMAX AND @SNF BETWEEN SNFMIN AND SNFMAX
END



__________________________________________________________________________


ALTER PROCEDURE [dbo].[SP_USER]
(
@MODE INT =NULL,
@USERID INT=NULL,
@USERNAME VARCHAR(50)=NULL,
@PASSWORD VARCHAR(MAX)=NULL,
@MOBILENO VARCHAR(20)=NULL,
@BRANCHNAME VARCHAR(50)=NULL,
@ADDRESS VARCHAR(50)=NULL,
@DEVICEID VARCHAR(250)=NULL,
@STARTDATE DATETIME=NULL,
@ENDDATE DATETIME=NULL,
@ISACTIVE BIT=NULL,
@ROLEID INT=NULL
)
AS
IF @MODE=1
BEGIN
SELECT USERID,USERNAME,PASSWORD,MOBILENO,BRANCHNAME,ADDRESS,DEVICEID,STARTDATE,ENDDATE,ISACTIVE,ROLEID FROM TBLUSERS WHERE MOBILENO=@MOBILENO AND DEVICEID=@DEVICEID
IF @@ROWCOUNT>0
RAISERROR('DEVICE IS ALREADY REGISTERED ,PLEASE LOGIN',18,2)
ELSE
BEGIN
SET @USERID = (SELECT ISNULL(MAX(USERID),0)+1 FROM TBLUSERS)
INSERT INTO TBLUSERS (USERID,USERNAME,PASSWORD,MOBILENO,BRANCHNAME,ADDRESS,DEVICEID,STARTDATE,ENDDATE,ISACTIVE,ROLEID)
VALUES
(@USERID,@USERNAME,@PASSWORD,@MOBILENO,@BRANCHNAME,@ADDRESS,@DEVICEID,GETDATE(),GETDATE()+10,1,1)
END
END

ELSE IF @MODE=2
BEGIN
SELECT USERID,USERNAME,PASSWORD,MOBILENO,BRANCHNAME,ADDRESS,DEVICEID,STARTDATE,ENDDATE,ISACTIVE,ROLEID FROM TBLUSERS
END

ELSE IF @MODE=3
BEGIN
UPDATE TBLUSERS SET USERNAME=@USERNAME,PASSWORD=@PASSWORD,BRANCHNAME=@BRANCHNAME,ADDRESS=@ADDRESS WHERE USERID=@USERID
END

ELSE IF @MODE=4
BEGIN
DELETE FROM TBLUSERS WHERE USERID=@USERID
END

ELSE IF @MODE=5
BEGIN
    IF NOT EXISTS (SELECT 1 FROM TBLUSERS WHERE DEVICEID=@DEVICEID AND MOBILENO=@MOBILENO)
    BEGIN
        RAISERROR('DEVICE IS NOT REGISTERED!', 18, 2)
    END
    ELSE
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM TBLUSERS WHERE DEVICEID=@DEVICEID AND MOBILENO=@MOBILENO AND GETDATE() BETWEEN STARTDATE AND ENDDATE)
        BEGIN
            RAISERROR('TRAIL PERIOD HAS EXPIRED, PLEASE PURCHASE PLAN!', 18, 2)
        END
        ELSE
        BEGIN
            SELECT USERID, USERNAME, PASSWORD, MOBILENO, BRANCHNAME, ADDRESS, DEVICEID, STARTDATE, ENDDATE, ISACTIVE, ROLEID
            FROM TBLUSERS
            WHERE DEVICEID=@DEVICEID AND MOBILENO=@MOBILENO AND GETDATE() BETWEEN STARTDATE AND ENDDATE
        END
    END
END